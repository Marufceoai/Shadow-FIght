<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shadow Fight</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            background: #0a0a0a;
            overflow: hidden;
            font-family: 'Segoe UI', Arial, sans-serif;
            color: #fff;
            user-select: none
        }

        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%
        }

        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10
        }

        .hud {
            position: absolute;
            top: 18px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            align-items: center;
            gap: 10px;
            width: 82%;
            max-width: 900px
        }

        .hud.on {
            display: flex
        }

        .hp-wrap {
            flex: 1;
            height: 26px;
            background: rgba(0, 0, 0, .7);
            border: 2px solid #555;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 12px rgba(0, 0, 0, .5)
        }

        .hp-wrap::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 40%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, .15), transparent);
            border-radius: 3px
        }

        .hp {
            height: 100%;
            transition: width .3s;
            border-radius: 2px
        }

        .hp.p1 {
            background: linear-gradient(90deg, #00ff88, #00f7ff);
            float: right
        }

        .hp.p2 {
            background: linear-gradient(90deg, #ff0040, #ff6600)
        }

        .pname {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            min-width: 70px;
            text-align: center
        }

        .pname.c1 {
            color: #00f7ff;
            text-shadow: 0 0 10px #00f7ff
        }

        .pname.c2 {
            color: #ff0040;
            text-shadow: 0 0 10px #ff0040
        }

        .tmr {
            font-size: 26px;
            font-weight: 700;
            min-width: 56px;
            text-align: center;
            color: #ffd700;
            text-shadow: 0 0 14px #ffd700;
            font-family: 'Courier New', monospace
        }

        .rinfo {
            position: absolute;
            top: 52px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 13px;
            color: #aaa;
            letter-spacing: 3px;
            text-transform: uppercase;
            display: none
        }

        .rinfo.on {
            display: block
        }

        #ann {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 72px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 8px;
            opacity: 0;
            z-index: 20;
            text-align: center;
            pointer-events: none;
            white-space: nowrap;
            transition: opacity .3s
        }

        #ann.round {
            color: #ffd700;
            text-shadow: 0 0 30px #ffd700, 0 0 60px #ff8800;
            animation: annIn .5s ease-out forwards
        }

        #ann.fight {
            color: #ff0040;
            text-shadow: 0 0 40px #ff0040, 0 0 80px #ff0040;
            animation: annIn .3s ease-out forwards
        }

        #ann.ko {
            color: #ff0040;
            font-size: 96px;
            text-shadow: 0 0 50px #ff0040, 0 0 100px #ff0040;
            animation: annIn .5s ease-out forwards
        }

        @keyframes annIn {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(2)
            }

            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1)
            }
        }

        #menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 30;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #0a0a0a 70%)
        }

        #menu h1 {
            font-size: 76px;
            font-weight: 900;
            letter-spacing: 12px;
            text-transform: uppercase;
            color: #fff;
            text-shadow: 0 0 20px #00f7ff, 0 0 40px #00f7ff, 0 0 80px #0088ff;
            margin-bottom: 8px;
            animation: tg 3s ease-in-out infinite alternate
        }

        #menu .sub {
            font-size: 16px;
            letter-spacing: 8px;
            color: #666;
            margin-bottom: 50px;
            text-transform: uppercase
        }

        #menu .go {
            font-size: 18px;
            letter-spacing: 4px;
            color: #00f7ff;
            animation: pul 2s ease-in-out infinite;
            cursor: pointer;
            pointer-events: auto
        }

        @keyframes tg {
            0% {
                text-shadow: 0 0 20px #00f7ff, 0 0 40px #00f7ff, 0 0 80px #0088ff
            }

            100% {
                text-shadow: 0 0 30px #ff0040, 0 0 60px #ff0040, 0 0 100px #ff0020
            }
        }

        @keyframes pul {

            0%,
            100% {
                opacity: .4
            }

            50% {
                opacity: 1
            }
        }

        .cg {
            position: absolute;
            bottom: 14px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            color: #444;
            text-align: center;
            letter-spacing: 1px;
            line-height: 1.8
        }

        .cg b {
            color: #00f7ff
        }

        #goscreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 30;
            background: rgba(0, 0, 0, .85)
        }

        #goscreen.on {
            display: flex
        }

        #goscreen h2 {
            font-size: 60px;
            font-weight: 900;
            letter-spacing: 8px;
            margin-bottom: 16px
        }

        #goscreen .sc {
            font-size: 22px;
            color: #aaa;
            margin-bottom: 36px
        }

        #goscreen button {
            padding: 14px 46px;
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 4px;
            text-transform: uppercase;
            background: transparent;
            border: 2px solid #00f7ff;
            color: #00f7ff;
            cursor: pointer;
            pointer-events: auto;
            transition: all .3s;
            border-radius: 4px
        }

        #goscreen button:hover {
            background: #00f7ff;
            color: #000;
            box-shadow: 0 0 30px #00f7ff
        }
    </style>
</head>

<body>
    <canvas id="c"></canvas>
    <div id="ui">
        <div class="hud" id="hud">
            <span class="pname c1">PLAYER</span>
            <div class="hp-wrap">
                <div class="hp p1" id="hp1"></div>
            </div>
            <div class="tmr" id="tmr">60</div>
            <div class="hp-wrap">
                <div class="hp p2" id="hp2"></div>
            </div>
            <span class="pname c2">ENEMY</span>
        </div>
        <div class="rinfo" id="rinfo">ROUND 1 / 3</div>
        <div id="ann"></div>
    </div>
    <div id="menu">
        <h1>SHADOW FIGHT</h1>
        <div class="sub">2D Arena Combat</div>
        <div class="go" id="startBtn">▶ PRESS ENTER TO START ◀</div>
        <div class="cg"><b>A/D</b> Move | <b>W</b> Jump | <b>J</b> Punch | <b>K</b> Kick | <b>L</b> Special | <b>I</b>
            Block</div>
    </div>
    <div id="goscreen">
        <h2 id="restxt"></h2>
        <div class="sc" id="sctxt"></div>
        <button id="replayBtn">PLAY AGAIN</button>
    </div>
    <script>
        (function () {
            "use strict";

            /* ======= SOUND ======= */
            var audioCtx = null, audioOk = false;
            function initAudio() {
                if (audioCtx) return;
                try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); audioOk = true } catch (e) { audioOk = false }
            }
            function sfx(type) {
                if (!audioOk) return;
                var c = audioCtx, t = c.currentTime, o, g;
                if (type === 'punch') { o = c.createOscillator(); g = c.createGain(); o.type = 'square'; o.frequency.setValueAtTime(200, t); o.frequency.exponentialRampToValueAtTime(80, t + .08); g.gain.setValueAtTime(.15, t); g.gain.exponentialRampToValueAtTime(.001, t + .08); o.connect(g); g.connect(c.destination); o.start(t); o.stop(t + .08) }
                else if (type === 'kick') { o = c.createOscillator(); g = c.createGain(); o.type = 'triangle'; o.frequency.setValueAtTime(120, t); o.frequency.exponentialRampToValueAtTime(40, t + .12); g.gain.setValueAtTime(.2, t); g.gain.exponentialRampToValueAtTime(.001, t + .12); o.connect(g); g.connect(c.destination); o.start(t); o.stop(t + .12) }
                else if (type === 'special') { o = c.createOscillator(); g = c.createGain(); o.type = 'sawtooth'; o.frequency.setValueAtTime(400, t); o.frequency.exponentialRampToValueAtTime(100, t + .3); g.gain.setValueAtTime(.15, t); g.gain.exponentialRampToValueAtTime(.001, t + .3); o.connect(g); g.connect(c.destination); o.start(t); o.stop(t + .3) }
                else if (type === 'hit') { var b = c.createBufferSource(), buf = c.createBuffer(1, c.sampleRate * .1 | 0, c.sampleRate), d = buf.getChannelData(0); for (var i = 0; i < d.length; i++)d[i] = (Math.random() * 2 - 1) * Math.exp(-i / (d.length * .2)); b.buffer = buf; g = c.createGain(); g.gain.setValueAtTime(.3, t); b.connect(g); g.connect(c.destination); b.start(t) }
                else if (type === 'block') { o = c.createOscillator(); g = c.createGain(); o.type = 'square'; o.frequency.setValueAtTime(1200, t); o.frequency.exponentialRampToValueAtTime(800, t + .05); g.gain.setValueAtTime(.08, t); g.gain.exponentialRampToValueAtTime(.001, t + .05); o.connect(g); g.connect(c.destination); o.start(t); o.stop(t + .05) }
                else if (type === 'ko') { o = c.createOscillator(); g = c.createGain(); o.type = 'sawtooth'; o.frequency.setValueAtTime(600, t); o.frequency.exponentialRampToValueAtTime(30, t + .8); g.gain.setValueAtTime(.25, t); g.gain.exponentialRampToValueAtTime(.001, t + .8); o.connect(g); g.connect(c.destination); o.start(t); o.stop(t + .8) }
                else if (type === 'start') { o = c.createOscillator(); g = c.createGain(); o.type = 'sine'; o.frequency.setValueAtTime(300, t); o.frequency.linearRampToValueAtTime(600, t + .3); g.gain.setValueAtTime(.12, t); g.gain.exponentialRampToValueAtTime(.001, t + .4); o.connect(g); g.connect(c.destination); o.start(t); o.stop(t + .4) }
            }

            /* ======= PARTICLES ======= */
            var parts = [], ambParts = [];
            function emitParts(x, y, n, col, spd, life, sz) {
                for (var i = 0; i < n; i++) {
                    var a = Math.random() * Math.PI * 2, s = spd * (.5 + Math.random());
                    parts.push({ x: x, y: y, vx: Math.cos(a) * s, vy: Math.sin(a) * s - 100, life: life * (.5 + Math.random() * .5), maxLife: life, col: col, sz: sz || 3, alive: true })
                }
            }
            function initAmbient(W, H) { ambParts = []; for (var i = 0; i < 25; i++)ambParts.push({ x: Math.random() * W, y: Math.random() * H * .8, s: Math.random() * 2 + .5, sp: Math.random() * 20 + 10, a: Math.random() }) }
            function updateParts(dt, W, H) {
                for (var i = parts.length - 1; i >= 0; i--) { var p = parts[i]; p.x += p.vx * dt; p.y += p.vy * dt; p.vy += 300 * dt; p.life -= dt; if (p.life <= 0) parts.splice(i, 1) }
                for (var j = 0; j < ambParts.length; j++) { var q = ambParts[j]; q.y -= q.sp * dt; q.a += dt * .5; if (q.y < 0) { q.y = H * .85; q.x = Math.random() * W } }
            }
            function drawParts(ctx) {
                for (var i = 0; i < parts.length; i++) { var p = parts[i], al = p.life / p.maxLife; ctx.globalAlpha = al; ctx.fillStyle = p.col; ctx.shadowColor = p.col; ctx.shadowBlur = p.sz * 3; ctx.beginPath(); ctx.arc(p.x, p.y, p.sz * al, 0, Math.PI * 2); ctx.fill(); ctx.shadowBlur = 0 }
                ctx.globalAlpha = 1;
                for (var j = 0; j < ambParts.length; j++) { var q = ambParts[j]; ctx.globalAlpha = .12 + Math.sin(q.a) * .08; ctx.fillStyle = '#ff8844'; ctx.beginPath(); ctx.arc(q.x, q.y, q.s, 0, Math.PI * 2); ctx.fill() }
                ctx.globalAlpha = 1;
            }

            /* ======= FIGHTER ======= */
            var ST = { IDLE: 'idle', WALK: 'walk', JUMP: 'jump', PUNCH: 'punch', KICK: 'kick', SPECIAL: 'special', BLOCK: 'block', HIT: 'hit', KO: 'ko', WIN: 'win' };
            var GROUND = .82;

            function Fighter(startX, isP1, glow) {
                this.startX = startX; this.x = startX; this.y = GROUND; this.vx = 0; this.vy = 0;
                this.isP1 = isP1; this.glow = glow; this.facing = isP1 ? 1 : -1;
                this.hp = 100; this.state = ST.IDLE; this.stateT = 0; this.animT = 0;
                this.grounded = true; this.blocking = false; this.attacking = false; this.atkHit = false;
                this.stunT = 0; this.combo = 0; this.lastHit = 0; this.specialCD = 0; this.kbVx = 0;
                this.speed = 280;
                this.la = { lA: 0, rA: 0, lL: 0, rL: 0, bd: 0 };
            }
            Fighter.prototype.reset = function (x) {
                this.x = x; this.y = GROUND; this.vx = 0; this.vy = 0; this.hp = 100;
                this.state = ST.IDLE; this.stateT = 0; this.grounded = true; this.blocking = false;
                this.attacking = false; this.atkHit = false; this.stunT = 0; this.combo = 0;
                this.specialCD = 0; this.kbVx = 0;
            };
            Fighter.prototype.setState = function (s) { if (this.state === ST.KO) return; this.state = s; this.stateT = 0; this.atkHit = false };
            Fighter.prototype.getDur = function () {
                if (this.state === ST.PUNCH) return .25; if (this.state === ST.KICK) return .35;
                if (this.state === ST.SPECIAL) return .5; if (this.state === ST.HIT) return .3; return 0;
            };
            Fighter.prototype.getDmg = function () {
                if (this.state === ST.PUNCH) return 5 + Math.random() * 3;
                if (this.state === ST.KICK) return 8 + Math.random() * 4;
                if (this.state === ST.SPECIAL) return 15 + Math.random() * 5; return 0;
            };
            Fighter.prototype.getAtkBox = function (W, H) {
                if (!this.attacking) return null;
                var cx = this.x * W, cy = this.y * H, r = 50, h = 30;
                if (this.state === ST.PUNCH) { r = 55; h = 25 }
                else if (this.state === ST.KICK) { r = 65; h = 30 }
                else if (this.state === ST.SPECIAL) { r = 80; h = 40 }
                return { x: this.facing > 0 ? cx : cx - r, y: cy - 60, w: r, h: h };
            };
            Fighter.prototype.getHurtBox = function (W, H) { return { x: this.x * W - 20, y: this.y * H - 110, w: 40, h: 110 } };
            Fighter.prototype.update = function (dt, keys, opp, W, H) {
                this.animT += dt; this.stateT += dt;
                if (this.specialCD > 0) this.specialCD -= dt;
                if (this.stunT > 0) { this.stunT -= dt; this.kbVx *= .9; this.x += this.kbVx * dt / W; this.x = Math.max(.05, Math.min(.95, this.x)); return }
                if (opp) this.facing = opp.x > this.x ? 1 : -1;
                var dur = this.getDur();
                if (dur > 0 && this.stateT >= dur) { this.attacking = false; this.setState(ST.IDLE) }
                if (this.state === ST.PUNCH) this.attacking = this.stateT > .05 && this.stateT < .15;
                else if (this.state === ST.KICK) this.attacking = this.stateT > .1 && this.stateT < .22;
                else if (this.state === ST.SPECIAL) this.attacking = this.stateT > .15 && this.stateT < .35;
                else this.attacking = false;
                if (!this.grounded) { this.vy += 1800 * dt; this.y += this.vy * dt / H; if (this.y >= GROUND) { this.y = GROUND; this.vy = 0; this.grounded = true; if (this.state === ST.JUMP) this.setState(ST.IDLE) } }
                this.kbVx *= .92; this.x += this.kbVx * dt / W;
                if (this.isP1 && this.state !== ST.KO) {
                    var canAct = this.state === ST.IDLE || this.state === ST.WALK || this.state === ST.JUMP || this.state === ST.BLOCK;
                    var canMove = canAct && this.state !== ST.BLOCK;
                    var moving = false;
                    if (canMove) {
                        if (keys.a) { this.vx = -this.speed; moving = true }
                        else if (keys.d) { this.vx = this.speed; moving = true }
                        else { this.vx *= .8; if (Math.abs(this.vx) < 10) this.vx = 0 }
                    }
                    if (keys.w && this.grounded && canAct) { this.vy = -700; this.grounded = false; this.setState(ST.JUMP) }
                    if (keys.i) { if (canAct && this.grounded) { this.blocking = true; if (this.state !== ST.BLOCK) this.setState(ST.BLOCK); this.vx = 0 } }
                    else { this.blocking = false; if (this.state === ST.BLOCK) this.setState(ST.IDLE) }
                    if (keys.j && canAct && !this.blocking) { keys.j = false; this.setState(ST.PUNCH) }
                    if (keys.k && canAct && !this.blocking) { keys.k = false; this.setState(ST.KICK) }
                    if (keys.l && canAct && !this.blocking && this.specialCD <= 0) { keys.l = false; this.setState(ST.SPECIAL); this.specialCD = 3 }
                    if (moving && this.grounded && this.state !== ST.BLOCK && this.state !== ST.PUNCH && this.state !== ST.KICK && this.state !== ST.SPECIAL) this.setState(ST.WALK);
                    else if (!moving && this.state === ST.WALK) this.setState(ST.IDLE);
                    this.x += this.vx * dt / W;
                }
                if (opp) { var dist = (this.x - opp.x) * W; if (Math.abs(dist) < 45) { this.x += (dist > 0 ? 1 : -1) * .002 } }
                this.x = Math.max(.05, Math.min(.95, this.x));
                this.updateLimbs(dt);
            };
            Fighter.prototype.updateLimbs = function (dt) {
                var t = this.animT, st = this.stateT, s = this.state, la = 0, ra = 0, ll = 0, rl = 0, bd = 0, f = this.facing;
                if (s === ST.IDLE) { la = Math.sin(t * 2) * .1; ra = -Math.sin(t * 2) * .1; ll = Math.sin(t * 1.5) * .05; rl = -Math.sin(t * 1.5) * .05 }
                else if (s === ST.WALK) { var c = Math.sin(t * 10); la = c * .5; ra = -c * .5; ll = -c * .6; rl = c * .6 }
                else if (s === ST.JUMP) { la = -.8; ra = -.8; ll = .3; rl = -.3 }
                else if (s === ST.PUNCH) { if (st < .1) { ra = -1.5 * (st / .1) * f } else { ra = -1.5 * (1 - (st - .1) / .15) * f } la = .3; bd = -.1 }
                else if (s === ST.KICK) { if (st < .15) { rl = -1.3 * (st / .15) * f } else { rl = -1.3 * (1 - (st - .15) / .2) * f } bd = -.15; la = .4; ra = -.4 }
                else if (s === ST.SPECIAL) { var p = st / .5; bd = Math.sin(p * Math.PI * 4) * .2; la = -1.2 * Math.sin(p * Math.PI * 2); ra = 1.2 * Math.sin(p * Math.PI * 2); ll = Math.sin(p * Math.PI) * .3; rl = -Math.sin(p * Math.PI) * .3 }
                else if (s === ST.BLOCK) { la = .8; ra = .8; bd = .1; ll = .15; rl = -.15 }
                else if (s === ST.HIT) { bd = .3; la = .5; ra = .5; ll = .2; rl = -.1 }
                else if (s === ST.KO) { var pk = Math.min(st / .5, 1); bd = 1.2 * pk; la = .8 * pk; ra = pk; ll = .5 * pk; rl = .3 * pk }
                else if (s === ST.WIN) { la = -1; ra = -1.5; bd = -.05 }
                var sp = 8;
                this.la.lA += (la - this.la.lA) * sp * dt; this.la.rA += (ra - this.la.rA) * sp * dt;
                this.la.lL += (ll - this.la.lL) * sp * dt; this.la.rL += (rl - this.la.rL) * sp * dt;
                this.la.bd += (bd - this.la.bd) * sp * dt;
            };
            Fighter.prototype.draw = function (ctx, W, H) {
                var cx = this.x * W, cy = this.y * H, f = this.facing, sc = H / 600, a = this.la;
                ctx.save(); ctx.translate(cx, cy); ctx.scale(f, 1); ctx.rotate(a.bd);
                ctx.shadowColor = this.glow; ctx.shadowBlur = 15 * sc; ctx.strokeStyle = this.glow; ctx.lineWidth = 3 * sc; ctx.lineCap = 'round';
                ctx.fillStyle = 'rgba(0,0,0,.9)';
                var hr = 14 * sc, hy = -95 * sc;
                ctx.beginPath(); ctx.arc(0, hy, hr, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                var sy = -80 * sc, hipy = -30 * sc;
                ctx.beginPath(); ctx.moveTo(0, sy); ctx.lineTo(0, hipy); ctx.stroke();
                var al = 35 * sc;
                ctx.save(); ctx.translate(0, sy); ctx.rotate(a.lA); ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(0, al); ctx.stroke(); ctx.restore();
                ctx.save(); ctx.translate(0, sy); ctx.rotate(a.rA); ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(0, al); ctx.stroke();
                if (this.state === ST.PUNCH && this.attacking) { ctx.fillStyle = this.glow; ctx.shadowBlur = 25 * sc; ctx.beginPath(); ctx.arc(0, al, 5 * sc, 0, Math.PI * 2); ctx.fill() }
                ctx.restore();
                var ll = 38 * sc;
                ctx.save(); ctx.translate(0, hipy); ctx.rotate(a.lL); ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(0, ll); ctx.stroke(); ctx.restore();
                ctx.save(); ctx.translate(0, hipy); ctx.rotate(a.rL); ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(0, ll); ctx.stroke();
                if (this.state === ST.KICK && this.attacking) { ctx.fillStyle = this.glow; ctx.shadowBlur = 25 * sc; ctx.beginPath(); ctx.arc(0, ll, 5 * sc, 0, Math.PI * 2); ctx.fill() }
                ctx.restore();
                if (this.state === ST.SPECIAL) { ctx.globalAlpha = .3 + Math.sin(this.stateT * 20) * .2; ctx.shadowBlur = 40 * sc; ctx.beginPath(); ctx.arc(0, -50 * sc, 45 * sc, 0, Math.PI * 2); ctx.fillStyle = this.glow; ctx.fill(); ctx.globalAlpha = 1 }
                if (this.state === ST.HIT && this.stateT < .1) { ctx.globalAlpha = .7; ctx.shadowBlur = 30 * sc; ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(0, -50 * sc, 40 * sc, 0, Math.PI * 2); ctx.fill(); ctx.globalAlpha = 1 }
                ctx.shadowBlur = 0; ctx.restore();
            };

            /* ======= AI ======= */
            function AI(fighter) { this.f = fighter; this.actT = 0; this.reactD = .4; this.diff = 1; this.thinkT = 0 }
            AI.prototype.setDiff = function (d) { this.diff = d; this.reactD = Math.max(.15, .5 - d * .08) };
            AI.prototype.update = function (dt, player, W) {
                var f = this.f; if (f.state === ST.KO || f.state === ST.HIT) return;
                this.thinkT -= dt; if (this.thinkT > 0) return;
                var dist = Math.abs(f.x - player.x) * W, dir = player.x > f.x ? 1 : -1;
                if (dist > 120) { f.vx = dir * f.speed * (.6 + this.diff * .1); if (f.grounded && f.state !== ST.PUNCH && f.state !== ST.KICK && f.state !== ST.SPECIAL && f.state !== ST.BLOCK) f.setState(ST.WALK); f.x += f.vx * dt / W }
                else if (dist < 60) { f.vx = -dir * f.speed * .4; f.x += f.vx * dt / W }
                else { f.vx *= .9; if (f.state === ST.WALK) f.setState(ST.IDLE) }
                f.x = Math.max(.05, Math.min(.95, f.x));
                if (player.attacking && Math.random() < .15 + this.diff * .05) { f.blocking = true; f.setState(ST.BLOCK); this.thinkT = .3 + Math.random() * .2; return }
                if (f.blocking && !player.attacking) { f.blocking = false; f.setState(ST.IDLE) }
                if (dist < 100 && f.state !== ST.PUNCH && f.state !== ST.KICK && f.state !== ST.SPECIAL && f.state !== ST.BLOCK) {
                    this.actT -= dt;
                    if (this.actT <= 0) {
                        var r = Math.random(), atkC = .3 + this.diff * .1;
                        if (r < atkC) { var ar = Math.random(); if (ar < .45) f.setState(ST.PUNCH); else if (ar < .8) f.setState(ST.KICK); else if (f.specialCD <= 0) { f.setState(ST.SPECIAL); f.specialCD = 3 } else f.setState(ST.PUNCH); this.thinkT = this.reactD + Math.random() * .2 }
                        this.actT = this.reactD * (.8 + Math.random() * .4);
                    }
                }
                if (Math.random() < .005 * this.diff && f.grounded) { f.vy = -700; f.grounded = false; f.setState(ST.JUMP) }
            };

            /* ======= GAME ======= */
            var canvas = document.getElementById('c');
            var ctx = canvas.getContext('2d');
            var W = 0, H = 0;
            var keys = { a: false, d: false, w: false, j: false, k: false, l: false, i: false };
            var player, enemy, ai;
            var GS = { MENU: 0, INTRO: 1, FIGHT: 2, REND: 3, OVER: 4 };
            var state = GS.MENU, round = 1, p1w = 0, p2w = 0, timer = 60, stateT = 0;
            var shakeAmt = 0, slowMo = 1, slowMoT = 0, moonA = 0, lastT = 0;
            var dmgNums = [];

            function resize() { W = window.innerWidth; H = window.innerHeight; canvas.width = W; canvas.height = H; initAmbient(W, H) }
            window.addEventListener('resize', resize);
            resize();

            player = new Fighter(.25, true, '#00f7ff');
            enemy = new Fighter(.75, false, '#ff0040');
            ai = new AI(enemy);

            window.addEventListener('keydown', function (e) {
                var k = e.key.toLowerCase();
                if (k === 'a') keys.a = true; if (k === 'd') keys.d = true; if (k === 'w') keys.w = true;
                if (k === 'j') keys.j = true; if (k === 'k') keys.k = true; if (k === 'l') keys.l = true; if (k === 'i') keys.i = true;
                if (k === 'enter' && state === GS.MENU) startGame();
                e.preventDefault();
            });
            window.addEventListener('keyup', function (e) {
                var k = e.key.toLowerCase();
                if (k === 'a') keys.a = false; if (k === 'd') keys.d = false; if (k === 'w') keys.w = false;
                if (k === 'j') keys.j = false; if (k === 'k') keys.k = false; if (k === 'l') keys.l = false; if (k === 'i') keys.i = false;
            });
            document.getElementById('startBtn').addEventListener('click', startGame);
            document.getElementById('replayBtn').addEventListener('click', function () { document.getElementById('goscreen').classList.remove('on'); startGame() });

            var annEl = document.getElementById('ann'), hudEl = document.getElementById('hud'), rinfoEl = document.getElementById('rinfo');
            var hp1El = document.getElementById('hp1'), hp2El = document.getElementById('hp2'), tmrEl = document.getElementById('tmr');

            function showAnn(txt, cls) { annEl.textContent = txt; annEl.className = cls; annEl.style.opacity = '1' }
            function hideAnn() { annEl.style.opacity = '0'; annEl.className = '' }

            function startGame() {
                initAudio();
                document.getElementById('menu').style.display = 'none';
                round = 1; p1w = 0; p2w = 0; startRound();
            }
            function startRound() {
                player.reset(.25); enemy.reset(.75); ai.setDiff(round); timer = 60;
                state = GS.INTRO; stateT = 0;
                hudEl.classList.add('on'); rinfoEl.classList.add('on');
                rinfoEl.textContent = 'ROUND ' + round + ' / 3';
                showAnn('ROUND ' + round, 'round'); sfx('start');
            }
            function onKO(winner, loser) {
                loser.setState(ST.KO); sfx('ko');
                emitParts(loser.x * W, loser.y * H - 50, 40, '#ffd700', 400, 1, 5);
                emitParts(loser.x * W, loser.y * H - 50, 30, '#ff0040', 350, .8, 4);
                slowMo = .2; slowMoT = 1; shakeAmt = Math.max(shakeAmt, 20);
                showAnn('K.O!', 'ko');
                if (winner.isP1) p1w++; else p2w++;
                state = GS.REND; stateT = 0;
            }
            function checkHit(atk, def) {
                if (!atk.attacking || atk.atkHit) return;
                var ab = atk.getAtkBox(W, H), db = def.getHurtBox(W, H); if (!ab) return;
                if (ab.x < db.x + db.w && ab.x + ab.w > db.x && ab.y < db.y + db.h && ab.y + ab.h > db.y) {
                    atk.atkHit = true;
                    var dmg = atk.getDmg(), blocked = def.blocking;
                    if (blocked) { dmg *= .3; sfx('block'); emitParts(def.x * W, def.y * H - 50, 4, '#aaa', 100, .3, 2) }
                    else {
                        var now = performance.now() / 1000;
                        if (now - atk.lastHit < 1) { atk.combo++; dmg *= 1 + atk.combo * .1 } else atk.combo = 1;
                        atk.lastHit = now;
                        def.setState(ST.HIT); def.stunT = .3; def.kbVx = atk.facing * 350;
                        var hx = (atk.x * W + def.x * W) / 2, hy = def.y * H - 60;
                        emitParts(hx, hy, 12, atk.glow, 250, .5, 3);
                        sfx(atk.state === ST.SPECIAL ? 'special' : atk.state === ST.KICK ? 'kick' : 'punch');
                        sfx('hit'); shakeAmt = Math.max(shakeAmt, atk.state === ST.SPECIAL ? 12 : 6);
                        dmgNums.push({ x: hx, y: hy - 20, txt: Math.round(dmg) + '', col: atk.glow, life: 1 });
                        if (atk.state === ST.SPECIAL) emitParts(hx, hy, 20, atk.glow, 300, .6, 4);
                    }
                    def.hp = Math.max(0, def.hp - dmg);
                    if (def.hp <= 0) onKO(atk, def);
                }
            }
            function updateUI() {
                hp1El.style.width = player.hp + '%'; hp2El.style.width = enemy.hp + '%';
                tmrEl.textContent = Math.ceil(timer);
            }

            function drawBg() {
                var grad = ctx.createLinearGradient(0, 0, 0, H);
                grad.addColorStop(0, '#0a0a1a'); grad.addColorStop(.5, '#1a1a2e'); grad.addColorStop(1, '#0d0d15');
                ctx.fillStyle = grad; ctx.fillRect(0, 0, W, H);
                moonA += .001;
                var mx = W * .8 + Math.sin(moonA) * 20, my = H * .15 + Math.cos(moonA * .7) * 10;
                ctx.save(); ctx.globalAlpha = .12; ctx.fillStyle = '#aabbff'; ctx.shadowColor = '#aabbff'; ctx.shadowBlur = 80;
                ctx.beginPath(); ctx.arc(mx, my, 50, 0, Math.PI * 2); ctx.fill();
                ctx.globalAlpha = .06; ctx.shadowBlur = 150; ctx.beginPath(); ctx.arc(mx, my, 120, 0, Math.PI * 2); ctx.fill(); ctx.restore();
                var gy = GROUND * H;
                var gg = ctx.createLinearGradient(0, gy, 0, H); gg.addColorStop(0, '#151520'); gg.addColorStop(1, '#0a0a10');
                ctx.fillStyle = gg; ctx.fillRect(0, gy, W, H - gy);
                ctx.save(); ctx.shadowColor = '#334'; ctx.shadowBlur = 10; ctx.strokeStyle = '#334'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(W, gy); ctx.stroke(); ctx.restore();
            }

            function loop(ts) {
                var rawDt = Math.min((ts - lastT) / 1000, .05); lastT = ts;
                if (slowMoT > 0) { slowMoT -= rawDt; if (slowMoT <= 0) slowMo = 1 }
                var dt = rawDt * slowMo;
                shakeAmt *= .85; if (shakeAmt < .5) shakeAmt = 0;
                ctx.save();
                if (shakeAmt > 0) ctx.translate((Math.random() - .5) * shakeAmt * 2, (Math.random() - .5) * shakeAmt * 2);
                drawBg(); updateParts(dt, W, H); drawParts(ctx);
                stateT += dt;
                if (state === GS.MENU) { }
                else if (state === GS.INTRO) {
                    player.update(dt, {}, enemy, W, H); enemy.update(dt, {}, player, W, H);
                    player.draw(ctx, W, H); enemy.draw(ctx, W, H);
                    if (stateT > 1.5) { hideAnn(); showAnn('FIGHT!', 'fight'); state = GS.FIGHT; stateT = 0; setTimeout(hideAnn, 800) }
                }
                else if (state === GS.FIGHT) {
                    timer -= dt; if (timer <= 0) {
                        timer = 0;
                        if (player.hp >= enemy.hp) { p1w++; showAnn('TIME!', 'round') } else { p2w++; showAnn('TIME!', 'round') }
                        state = GS.REND; stateT = 0;
                    }
                    player.update(dt, keys, enemy, W, H); ai.update(dt, player, W); enemy.update(dt, {}, player, W, H);
                    checkHit(player, enemy); checkHit(enemy, player);
                    player.draw(ctx, W, H); enemy.draw(ctx, W, H); updateUI();
                }
                else if (state === GS.REND) {
                    player.update(dt, {}, enemy, W, H); enemy.update(dt, {}, player, W, H);
                    if (stateT > 1 && stateT < 1.05) { if (player.hp > 0 && player.state !== ST.WIN) player.setState(ST.WIN); if (enemy.hp > 0 && enemy.state !== ST.WIN) enemy.setState(ST.WIN) }
                    player.draw(ctx, W, H); enemy.draw(ctx, W, H);
                    if (stateT > 3) {
                        hideAnn();
                        if (p1w >= 2 || p2w >= 2 || round >= 3) {
                            state = GS.OVER; var win = p1w > p2w;
                            document.getElementById('restxt').textContent = win ? 'YOU WIN' : 'DEFEAT';
                            document.getElementById('restxt').style.color = win ? '#00f7ff' : '#ff0040';
                            document.getElementById('restxt').style.textShadow = '0 0 40px ' + (win ? '#00f7ff' : '#ff0040');
                            document.getElementById('sctxt').textContent = p1w + ' - ' + p2w;
                            document.getElementById('goscreen').classList.add('on');
                            hudEl.classList.remove('on'); rinfoEl.classList.remove('on');
                        } else { round++; startRound() }
                    }
                }
                else if (state === GS.OVER) {
                    player.update(dt, {}, enemy, W, H); enemy.update(dt, {}, player, W, H);
                    player.draw(ctx, W, H); enemy.draw(ctx, W, H);
                }
                // damage numbers
                for (var i = dmgNums.length - 1; i >= 0; i--) {
                    var d = dmgNums[i]; d.y -= 60 * dt; d.life -= dt * 2;
                    ctx.globalAlpha = Math.max(0, d.life); ctx.font = 'bold 22px sans-serif'; ctx.fillStyle = d.col; ctx.shadowColor = d.col; ctx.shadowBlur = 10; ctx.fillText(d.txt, d.x, d.y); ctx.shadowBlur = 0;
                    if (d.life <= 0) dmgNums.splice(i, 1)
                }
                ctx.globalAlpha = 1; ctx.restore();
                requestAnimationFrame(loop);
            }
            requestAnimationFrame(loop);
        })();
    </script>
</body>

</html>